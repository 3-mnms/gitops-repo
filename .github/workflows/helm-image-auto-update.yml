name: "ğŸ”„ Helm ì´ë¯¸ì§€ íƒœê·¸ ìë™ ë°˜ì˜"
run-name: "ğŸ”„ ${{ github.event.client_payload.service }} â€“ ${{ github.event.client_payload.tag }}"

on:
  repository_dispatch:
    types: [ image-updated ]
  workflow_dispatch: {}

permissions:
  contents: write

env:
  TARGET_BRANCH: ${{ github.event.client_payload.targetBranch || 'feature/MNMS-299' }}

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - id: map
        run: |
          # íŒŒì¼ ê²½ë¡œ ë§¤í•‘ (prodë§Œ ì‚¬ìš©)
          declare -A FILE=( \
            [fe-user]="values/nginx-client/values.yaml" \
            [fe-admin]="values/nginx-admin/values.yaml" \
            [booking]="values/api/booking/values-prod.yaml" \
            [festival]="values/api/festival/values-prod.yaml" \
            [payment]="values/api/payment/values-prod.yaml" \
            [gateway]="values/api/gateway/values-prod.yaml" \
            [infra]="values/infra/values-prod.yaml" \
            [api]="values/api/values-prod.yaml" \
          )
          # ë£¨íŠ¸ í‚¤ ë§¤í•‘
          declare -A ROOT=( \
            [fe-user]="" \
            [fe-admin]="" \
            [booking]="apiBooking" \
            [festival]="apiFestival" \
            [payment]="apiPayment" \
            [gateway]="apiGateway" \
            [infra]="" \
            [api]="" \
          )

          svc="${{ github.event.client_payload.service }}"
          file="${FILE[$svc]}"
          root="${ROOT[$svc]}"

          if [[ -z "$file" ]]; then
            echo "Unknown service: $svc" >&2
            exit 1
          fi

          echo "file=$file" >> "$GITHUB_OUTPUT"
          echo "root=$root" >> "$GITHUB_OUTPUT"
          echo "Mapped $svc -> file=$file root=$root"

      - name: Patch values
        env:
          IMG:  ${{ github.event.client_payload.image }}   # ex) rookiesdogun/api-payment
          TAG:  ${{ github.event.client_payload.tag }}
          FILE: ${{ steps.map.outputs.file }}
          ROOT: ${{ steps.map.outputs.root }}              # ex) apiPayment / ""(ì—†ìŒ)
        run: |
          set -euo pipefail

          REPO_ONLY="${IMG##*/}"  # ex) api-payment
          # image ë…¸ë“œì˜ ì ˆëŒ€ ê²½ë¡œ: .image ë˜ëŠ” .<root>.image
          if [[ -z "${ROOT}" ]]; then
            BPATH='.image'
          else
            BPATH=".[\"${ROOT}\"].image"
          fi

          echo "FILE=${FILE}"
          echo "BPATH=${BPATH}"
          echo "IMG=${IMG}"
          echo "REPO_ONLY=${REPO_ONLY}"
          echo "TAG=${TAG}"

          if yq -e "${BPATH} | has(\"registry\")" "$FILE" >/dev/null 2>&1; then
            # registryê°€ ìˆìœ¼ë©´ repositoryì—ëŠ” 'ì´ë¦„'ë§Œ
            yq -i "
              ${BPATH}.repository = env(REPO_ONLY) |
              ${BPATH}.tag        = env(TAG)
            " "$FILE"
          else
            # registryê°€ ì—†ìœ¼ë©´ repositoryì—ëŠ” 'í’€ë„¤ì„'
            yq -i "
              ${BPATH}.repository = env(IMG) |
              ${BPATH}.tag        = env(TAG)
            " "$FILE"
          fi

          FINAL_REPO=$(yq -r "${BPATH}.repository // \"\"" "$FILE")
          if [[ -z "${FINAL_REPO}" ]]; then
            echo "âŒ repository resolved to empty. Abort."; exit 1
          fi
          echo "âœ… repository=${FINAL_REPO}"



      - name: Auto commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: ${{ env.TARGET_BRANCH }}
          commit_message: |
            MNMS-302 chore(helm): ${{ github.event.client_payload.service }} ì´ë¯¸ì§€ íƒœê·¸ â†’ ${{ github.event.client_payload.tag }}
          file_pattern: ${{ steps.map.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}